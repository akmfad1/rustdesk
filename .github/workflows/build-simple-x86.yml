name: Build RustDesk Sciter (32-bit Windows)

# ============================================
# ğŸš€ Ù†Ø³Ø®Ù‡ 32 Ø¨ÛŒØªÛŒ ÙˆÛŒÙ†Ø¯ÙˆØ² - Sciter
# Ø²Ù…Ø§Ù† build: Ø­Ø¯ÙˆØ¯ 15-20 Ø¯Ù‚ÛŒÙ‚Ù‡
# ============================================

on:
  workflow_dispatch:
    inputs:
      server:
        description: 'Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± (Ù…Ø«Ø§Ù„: desk.timextools.ir)'
        required: true
        default: 'desk.timextools.ir'
        type: string
      public_key:
        description: 'Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø² id_ed25519.pub'
        required: true
        default: 'vuw04gfylmMzuWj2nFEV5a2gMbfsdnKwvbwsqhGBu0o='
        type: string
      app_name:
        description: 'Ù†Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡'
        required: false
        default: 'AWdesk'
        type: string

env:
  RUST_VERSION: "1.75"
  VCPKG_COMMIT_ID: "2023.04.15"
  # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±Ø§ÛŒ 32 Ø¨ÛŒØª
  TARGET_ARCH: "i686-pc-windows-msvc"
  VCPKG_TRIPLET: "x86-windows-static"

jobs:
  build:
    name: ğŸ”¨ Build Windows x86 (32-bit)
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Clone RustDesk
        uses: actions/checkout@v4
        with:
          repository: rustdesk/rustdesk
          submodules: recursive
          ref: master

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: i686-pc-windows-msvc

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ Install LLVM
        run: |
          choco install -y llvm --version=15.0.2 --allow-downgrade --force
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

      - name: ğŸ“¦ Setup vcpkg
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          git checkout ${{ env.VCPKG_COMMIT_ID }}
          ./bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=$PWD" >> $GITHUB_ENV

      - name: ğŸ“š Install Dependencies (32-bit)
        shell: bash
        run: |
          # Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ 32 Ø¨ÛŒØªÛŒ
          $VCPKG_ROOT/vcpkg install libvpx:x86-windows-static libyuv:x86-windows-static opus:x86-windows-static aom:x86-windows-static

      - name: ğŸ“¥ Download Sciter (32-bit)
        shell: bash
        run: |
          mkdir -p target/debug target/release target/i686-pc-windows-msvc/release
          # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ 32 Ø¨ÛŒØªÛŒ Sciter
          curl -L -o target/debug/sciter.dll https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x32/sciter.dll
          cp target/debug/sciter.dll target/release/
          cp target/debug/sciter.dll target/i686-pc-windows-msvc/release/

      - name: âš™ï¸ Configure Server & Key
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ ØªÙ†Ø¸ÛŒÙ… Ø³Ø±ÙˆØ±: ${{ inputs.server }}"
          
          $configPath = "libs/hbb_common/src/config.rs"
          $content = Get-Content $configPath -Raw
          
          # ØªÙ†Ø¸ÛŒÙ… Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±
          $content = $content -replace 'pub const RENDEZVOUS_SERVERS: &\[&str\] = &\[[^\]]*\];', 
            "pub const RENDEZVOUS_SERVERS: &[&str] = &[`"${{ inputs.server }}`"];"
          
          # ØªÙ†Ø¸ÛŒÙ… Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ
          $content = $content -replace 'pub const RS_PUB_KEY: &str = "[^"]*";',
            "pub const RS_PUB_KEY: &str = `"${{ inputs.public_key }}`";"
          
          # ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡
          $content = $content -replace 'Arc::new\(RwLock::new\("RustDesk"\.to_owned\(\)\)\)',
            "Arc::new(RwLock::new(`"${{ inputs.app_name }}`".to_owned()))"
          
          Set-Content $configPath $content
          Write-Host "âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯"

      - name: ğŸ¨ Configure Cargo.toml
        shell: pwsh
        run: |
          $cargoPath = "Cargo.toml"
          $content = Get-Content $cargoPath -Raw
          
          # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† inline build
          $content = $content -replace 'default = \["use_dasp"\]', 'default = ["use_dasp", "inline"]'
          
          Set-Content $cargoPath $content

      - name: ğŸ–¼ï¸ Build Inline Resources
        run: python res/inline-sciter.py

      - name: ğŸ”¨ Build Application (32-bit)
        shell: bash
        env:
          LIBCLANG_PATH: "C:/Program Files/LLVM/bin"
          VCPKG_DEFAULT_TRIPLET: "x86-windows-static"
        run: |
          # Ø¨ÛŒÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ù…Ø§Ø±ÛŒ 32 Ø¨ÛŒØª
          cargo build --release --target i686-pc-windows-msvc
          echo "âœ… Build completed!"

      - name: ğŸ“¦ Package
        shell: pwsh
        run: |
          $outputDir = "release"
          New-Item -ItemType Directory -Force -Path $outputDir
          
          # Ú©Ù¾ÛŒ Ø§Ø² Ù…Ø³ÛŒØ± 32 Ø¨ÛŒØªÛŒ
          Copy-Item "target/i686-pc-windows-msvc/release/rustdesk.exe" "$outputDir/${{ inputs.app_name }}.exe"
          Copy-Item "target/debug/sciter.dll" $outputDir/
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
          $info = "# ${{ inputs.app_name }} Configuration`n"
          $info += "# Server: ${{ inputs.server }}`n"
          $info += "# Architecture: Windows x86 (32-bit)`n"
          $info += "# Generated: $(Get-Date)`n"
          $info | Out-File "$outputDir/info.txt"
          
          Compress-Archive -Path "$outputDir/*" -DestinationPath "${{ inputs.app_name }}-windows-x86.zip"
          
          Write-Host "âœ… Package created: ${{ inputs.app_name }}-windows-x86.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-windows-x86
          path: |
            ${{ inputs.app_name }}-windows-x86.zip
            release/
          retention-days: 30

      - name: ğŸ“Š Build Summary
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "âœ… BUILD COMPLETED SUCCESSFULLY!"
          Write-Host "========================================"
          Write-Host ""
          Write-Host "ğŸ“‹ Configuration:"
          Write-Host "   App Name: ${{ inputs.app_name }}"
          Write-Host "   Server: ${{ inputs.server }}"
          Write-Host "   Architecture: x86 (32-bit)"
          Write-Host ""
          Write-Host "ğŸ“¥ Download your client from Artifacts section above"
          Write-Host ""
